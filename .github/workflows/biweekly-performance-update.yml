name: ğŸ’¹ æ¯2å‘¨ç»©æ•ˆåˆ†ææ›´æ–°

on:
  schedule:
    # æ¯2å‘¨è¿è¡Œï¼šæ¯æœˆ1æ—¥å’Œ15æ—¥ UTC 02:00ï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ10ç‚¹ï¼‰
    - cron: '0 2 1,15 * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-performance:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openbb beautifulsoup4 requests

      - name: ğŸ” Show environment info
        run: |
          echo "Python version: $(python --version)"
          echo "Working directory: $(pwd)"
          echo "Git branch: ${{ github.ref_name }}"
          date

      - name: â° è®¡ç®—é¢„è®¡è€—æ—¶
        run: |
          echo "â±ï¸ ç»©æ•ˆè®¡ç®—é¢„è®¡éœ€è¦ 2-5 å°æ—¶"
          echo "ğŸ“Š å°†è®¡ç®—å…¨éƒ¨ 81 ä¸ªæŠ•èµ„ç»„åˆçš„æ”¶ç›Šç‡"

      - name: ğŸ“Š æŠ“å–æŒä»“æ•°æ®
        run: |
          echo "ğŸ“… $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ” å¼€å§‹æŠ“å–æŒä»“æ•°æ®..."
          python scripts/scrape_holdings.py || echo "âš ï¸ æŒä»“æ•°æ®æŠ“å–è„šæœ¬ä¸å­˜åœ¨"
          echo "âœ… æŒä»“æ•°æ®æŠ“å–å®Œæˆ"

      - name: ğŸ’¹ è®¡ç®—ç»©æ•ˆåˆ†æ
        run: |
          echo "ğŸ“… $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ’¹ å¼€å§‹è®¡ç®—ç»„åˆæ”¶ç›Š..."
          echo "â° è¿™æ˜¯ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼ˆ2-5å°æ—¶ï¼‰"
          python scripts/calculate_performance.py || echo "âš ï¸ ç»©æ•ˆè®¡ç®—è„šæœ¬ä¸å­˜åœ¨"
          echo "âœ… æ”¶ç›Šè®¡ç®—å®Œæˆ"

      - name: ğŸ“ åˆ›å»ºæ›´æ–°æ‘˜è¦
        run: |
          echo "## ğŸ’¹ æ¯2å‘¨ç»©æ•ˆåˆ†ææ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ• æ›´æ–°æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… å®Œæˆçš„ä»»åŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æŒä»“æ•°æ®æŠ“å–" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ”¶ç›Šè®¡ç®—ï¼ˆå…¨éƒ¨81ä¸ªç»„åˆï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… 5å¹´ã€2å¹´ã€1å¹´ã€6æœˆã€3æœˆæ”¶ç›Šç‡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ˆ æ•°æ®ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          if [ -f "data/performance.json" ]; then
            echo "- âœ… æ”¶ç›Šæ•°æ®å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸš€ æäº¤å¹¶æ¨é€
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet && git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ•°æ®å˜æ›´"
          else
            echo "ğŸ“ æäº¤ç»©æ•ˆæ•°æ®æ›´æ–°..."
            git add data/ src/ || true
            git commit -m "ğŸ’¹ åŒå‘¨ç»©æ•ˆæ›´æ–°: $(date '+%Y-%m-%d')

            - æŒä»“æ•°æ®å·²æ›´æ–°
            - ç»©æ•ˆæ•°æ®å·²è®¡ç®—ï¼ˆ81ä¸ªç»„åˆï¼‰
            - åŒ…å«5å¹´ã€2å¹´ã€1å¹´ã€6æœˆã€3æœˆæ”¶ç›Šç‡

            [skip ci]" || echo "â„¹ï¸ æ²¡æœ‰æ–°æ•°æ®éœ€è¦æäº¤"
            git push
            echo "âœ… ç»©æ•ˆæ•°æ®å·²æäº¤"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŒ è§¦å‘ Netlify éƒ¨ç½²
        if: success()
        run: |
          echo "ğŸš€ è§¦å‘ Netlify é‡æ–°éƒ¨ç½²..."
          response=$(curl -s -X POST -d "{}" "${{ secrets.NETLIFY_BUILD_HOOK }}")
          echo "Netlify å“åº”: $response"
          echo "âœ… Netlify éƒ¨ç½²å·²è§¦å‘"
        env:
          NETLIFY_BUILD_HOOK: ${{ secrets.NETLIFY_BUILD_HOOK }}
