name: ğŸ¤– Update Dashboard Data

on:
  schedule:
    # æ¯å¤© UTC 01:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ9ç‚¹ï¼Œå¤ä»¤æ—¶8ç‚¹ï¼‰
    - cron: '0 1 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install openbb beautifulsoup4 requests schedule

      - name: ğŸ” Show environment info
        run: |
          echo "Python version: $(python --version)"
          echo "Working directory: $(pwd)"
          echo "Git branch: ${{ github.ref_name }}"
          date

      - name: ğŸ“Š Step 1: Scrape holdings data
        id: scrape
        run: |
          echo "ğŸ“… $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ” å¼€å§‹æŠ“å–æŒä»“æ•°æ®..."
          python scripts/scrape_holdings.py
          echo "âœ… æŒä»“æ•°æ®æŠ“å–å®Œæˆ"
        continue-on-error: false

      - name: ğŸ’° Step 2: Calculate performance
        id: performance
        run: |
          echo "ğŸ“… $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ’¹ å¼€å§‹è®¡ç®—ç»„åˆæ”¶ç›Š..."
          python scripts/calculate_performance.py
          echo "âœ… æ”¶ç›Šè®¡ç®—å®Œæˆ"
        continue-on-error: true  # å¦‚æœOpenBBå¤±è´¥ï¼Œç»§ç»­éƒ¨ç½²

      - name: ğŸ”„ Step 3: Update dashboard
        id: dashboard
        run: |
          echo "ğŸ“… $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸ”„ å¼€å§‹æ›´æ–°ä»ªè¡¨æ¿..."
          python scripts/update_dashboard.py
          echo "âœ… ä»ªè¡¨æ¿æ›´æ–°å®Œæˆ"

      - name: ğŸ“ Step 4: Create summary
        id: summary
        run: |
          echo "## ğŸ“Š æ•°æ®æ›´æ–°æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ• æ›´æ–°æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… å®Œæˆçš„ä»»åŠ¡" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æŒä»“æ•°æ®æŠ“å–" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.performance.outcome }}" == "success" ]; then
            echo "- âœ… æ”¶ç›Šè®¡ç®—ï¼ˆçœŸå®æ•°æ®ï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ æ”¶ç›Šè®¡ç®—ï¼ˆä½¿ç”¨ç¼“å­˜æ•°æ®ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- âœ… ä»ªè¡¨æ¿æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ˆ æ•°æ®ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          if [ -f "data/holdings.json" ]; then
            INVESTORS=$(python -c "import json; print(len(json.load(open('data/holdings.json'))))" 2>/dev/null || echo "N/A")
            echo "- æŠ•èµ„è€…æ•°é‡ï¼š$INVESTORS" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "data/performance.json" ]; then
            echo "- âœ… æ”¶ç›Šæ•°æ®å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸš€ Step 5: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --quiet && git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ£€æµ‹åˆ°æ•°æ®å˜æ›´"
          else
            echo "ğŸ“ æäº¤æ•°æ®æ›´æ–°..."
            git add data/ index.html report.html
            git commit -m "ğŸ¤– Auto-update: $(date '+%Y-%m-%d %H:%M:%S UTC')

            - æŒä»“æ•°æ®å·²æ›´æ–°
            - æ”¶ç›Šæ•°æ®å·²è®¡ç®—
            - ä»ªè¡¨æ¿å·²åˆ·æ–°

            [skip ci]"
            git push
            echo "âœ… æ•°æ®å·²æäº¤å¹¶æ¨é€åˆ° GitHub"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŒ Step 6: Trigger Netlify deployment
        if: success()
        run: |
          echo "ğŸš€ è§¦å‘ Netlify é‡æ–°éƒ¨ç½²..."
          response=$(curl -s -X POST -d "{}" "${{ secrets.NETLIFY_BUILD_HOOK }}")
          echo "Netlify å“åº”: $response"
          echo "âœ… Netlify éƒ¨ç½²å·²è§¦å‘"
        env:
          NETLIFY_BUILD_HOOK: ${{ secrets.NETLIFY_BUILD_HOOK }}

      - name: âœ… Success notification
        if: success()
        run: |
          echo "ğŸ‰ æ•°æ®æ›´æ–°æˆåŠŸå®Œæˆï¼"
          echo "ğŸ“Š æŸ¥çœ‹æ›´æ–°åçš„ä»ªè¡¨æ¿ï¼šhttps://investor-dashboard.netlify.app"

      - name: âŒ Failure notification
        if: failure()
        run: |
          echo "âŒ æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1
